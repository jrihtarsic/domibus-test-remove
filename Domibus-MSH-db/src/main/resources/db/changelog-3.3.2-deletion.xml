<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="EDELIVERY-2315" author="CatalinEnache">
        <sql dbms="oracle">
            define from = '20-JAN-17 10.00.00.000000 AM';

            define to = '20-DEC-18 03.00.00.000000 PM';

            Delete from TB_MESSAGING where (SIGNAL_MESSAGE_ID IN (select ID_PK from TB_SIGNAL_MESSAGE where messageInfo_ID_PK IN (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID IN (SELECT message_id FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to'))));

            Delete from TB_MESSAGING where (USER_MESSAGE_ID IN (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK IN (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in (SELECT message_id FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to'))));


            Delete FROM TB_ERROR_LOG where (ERROR_SIGNAL_MESSAGE_ID IN (SELECT MESSAGE_ID FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to'));
            Delete FROM TB_ERROR_LOG where (MESSAGE_IN_ERROR_ID IN (SELECT MESSAGE_ID FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to'));

            Delete from TB_PARTY_ID where FROM_ID IN (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between '&amp;from' and '&amp;to'));

            Delete from TB_PARTY_ID where TO_ID IN (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between '&amp;from' and '&amp;to'));

            Delete from TB_RECEIPT_DATA where RECEIPT_ID IN (select ID_PK from TB_RECEIPT where ID_PK IN (select receipt_ID_PK from TB_SIGNAL_MESSAGE where messageInfo_ID_PK IN  (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in (SELECT message_id FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to'))));

            Delete from TB_PROPERTY where MESSAGEPROPERTIES_ID IN (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between '&amp;from' and '&amp;to'));

            Delete from TB_PROPERTY where PARTPROPERTIES_ID IN (select ID_PK from TB_PART_INFO where PAYLOADINFO_ID IN (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between '&amp;from' and '&amp;to')));

            Delete from TB_PART_INFO where PAYLOADINFO_ID IN (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between '&amp;from' and '&amp;to'));

            Delete from TB_RAWENVELOPE_LOG where USERMESSAGE_ID_FK IN (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK IN (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in (SELECT message_id FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to')));

            Delete from TB_RAWENVELOPE_LOG where SIGNALMESSAGE_ID_FK IN (select ID_PK from TB_SIGNAL_MESSAGE where messageInfo_ID_PK IN (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in (SELECT message_id FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to')));

            Delete from TB_ERROR where SIGNALMESSAGE_ID IN (select ID_PK from TB_SIGNAL_MESSAGE where messageInfo_ID_PK IN (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in (SELECT message_id FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to')));

            Delete from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between '&amp;from' and '&amp;to');

            Delete from TB_SIGNAL_MESSAGE where messageInfo_ID_PK IN (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in (SELECT message_id FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to'));

            Delete from TB_RECEIPT where ID_PK NOT IN(select receipt_ID_PK from TB_SIGNAL_MESSAGE);

            Delete from TB_MESSAGE_INFO where MESSAGE_ID in (SELECT message_id FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to');

            Delete FROM TB_MESSAGE_LOG where received between '&amp;from' and '&amp;to';
        </sql>

        <sql dbms="mysql">
            set @from='2017-01-20 10:00:00', @to='2018-12-20 15:00:00';

            Delete from TB_MESSAGING where
            (SIGNAL_MESSAGE_ID IN
            (select ID_PK from TB_SIGNAL_MESSAGE where messageInfo_ID_PK IN
            (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in
            (SELECT message_id FROM TB_MESSAGE_LOG where received between @from and @to))));

            Delete from TB_MESSAGING where
            (USER_MESSAGE_ID IN
            (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK IN
            (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in
            (SELECT message_id FROM TB_MESSAGE_LOG where received between @from and @to))));


            Delete FROM TB_ERROR_LOG where
            (ERROR_SIGNAL_MESSAGE_ID IN
            (SELECT MESSAGE_ID FROM TB_MESSAGE_LOG where received between @from and @to));
            Delete FROM TB_ERROR_LOG where
            (MESSAGE_IN_ERROR_ID IN
            (SELECT MESSAGE_ID FROM TB_MESSAGE_LOG where received between @from and @to));

            Delete from TB_PARTY_ID where FROM_ID IN
            (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between @from and @to));

            Delete from TB_PARTY_ID where TO_ID IN
            (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between @from and @to));

            Delete from TB_RECEIPT_DATA where RECEIPT_ID IN
            (select ID_PK from TB_RECEIPT where ID_PK IN
            (select receipt_ID_PK from TB_SIGNAL_MESSAGE where messageInfo_ID_PK IN
            (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in
            (SELECT message_id FROM TB_MESSAGE_LOG where received between @from and @to))));

            Delete from TB_PROPERTY where MESSAGEPROPERTIES_ID IN
            (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between @from and @to));

            Delete from TB_PROPERTY where PARTPROPERTIES_ID IN
            (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between @from and @to));

            Delete from TB_PART_INFO where PAYLOADINFO_ID IN
            (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between @from and @to));

            Delete from TB_RAWENVELOPE_LOG where USERMESSAGE_ID_FK IN
            (select ID_PK from TB_USER_MESSAGE where messageInfo_ID_PK IN
            (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in
            (SELECT message_id FROM TB_MESSAGE_LOG where received between @from and @to)));

            Delete from TB_RAWENVELOPE_LOG where SIGNALMESSAGE_ID_FK IN
            (select ID_PK from TB_SIGNAL_MESSAGE where messageInfo_ID_PK IN
            (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in
            (SELECT message_id FROM TB_MESSAGE_LOG where received between @from and @to)));


            Delete from TB_ERROR where SIGNALMESSAGE_ID IN (select ID_PK from TB_SIGNAL_MESSAGE where messageInfo_ID_PK IN (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in
            (SELECT message_id FROM TB_MESSAGE_LOG where received between @from and @to)));

            Delete from TB_USER_MESSAGE where messageInfo_ID_PK in (select ID_PK from TB_MESSAGE_INFO where TIME_STAMP between @from and @to);

            Delete from TB_SIGNAL_MESSAGE where messageInfo_ID_PK IN (select ID_PK from TB_MESSAGE_INFO where MESSAGE_ID in
            (SELECT message_id FROM TB_MESSAGE_LOG where received between @from and @to));

            Delete from TB_RECEIPT where ID_PK NOT IN(select receipt_ID_PK from TB_SIGNAL_MESSAGE);

            Delete from TB_MESSAGE_INFO where MESSAGE_ID in (SELECT message_id FROM TB_MESSAGE_LOG where received between @from and @to);

            Delete FROM TB_MESSAGE_LOG where received between @from and @to;
        </sql>
    </changeSet>

</databaseChangeLog>
